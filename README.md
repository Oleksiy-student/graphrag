# GraphRAG (v1.65)

GraphRAG is an experimental **Retrieval-Augmented Generation (RAG)** pipeline written in Java.  
It combines **graph-based document storage** with **local embeddings** generated by **Qwen3 via Ollama**.

---

## Features
- üìÑ **PDF/Text ingestion** ‚Üí documents are split into smaller chunks for indexing  
- üîó **Graph-based storage** ‚Üí built using [Apache TinkerPop / TinkerGraph](https://tinkerpop.apache.org/)  
- üß† **Embeddings** ‚Üí generated with **Qwen3 (via Ollama localhost API)** and stored using **Supabase**  
- üîç **Retriever** ‚Üí **Supabase** vector similarity search to find relevant chunks  
- üîç **Response generation** ‚Üí **Deepseek-r1 (via Ollama localhost API)** gives a complete response based on the retrieved chunks 
- üõ†Ô∏è Modular pipeline for plugging in additional stores or models  

---

## Requirements
- **Java 17+**
- **Maven**
- **Ollama** installed locally ([https://ollama.com](https://ollama.com))
- Model: `qwen3:4b` pulled via Ollama  
  ```bash
  ollama pull qwen3:4b
  ```
- **Supabase** project with a table for document chunks, e.g., document_chunks

---

  # Supabase Vector Store Setup
  Table Schema Example
  ```sql
  create table public.document_chunks (
      id uuid primary key default gen_random_uuid(),
      chunk_index text,
      chunk_text text,
      metadata jsonb,
      embedding vector(2560)
  );
  ```
  # Generic Vector Search Function
  ```sql
  create or replace function public.vector_search(
      table_name text,
      query_vector vector(2560),
      top_k int
  )
  returns table (
      id uuid,
      chunk_index text,
      chunk_text text,
      metadata jsonb,
      embedding vector(2560),
      score float
  )
  language plpgsql
  as $$
  begin
      return query execute format(
          'select id, chunk_index, chunk_text, metadata, embedding, (embedding <#> $1) as score
          from %I
          order by score asc
          limit $2',
          table_name
      ) using query_vector, top_k;
  end;
  $$;
  ```
  This allows SupabaseRetriever to query any table with the correct schema, removing the need for per-table RPC functions.

---

## Run
```bash
mvn clean compile exec:java -Dexec.mainClass="com.ok.App"
```

You should see:
- Embedding vectors printed in debug logs  
- Chunks being ingested into the graph  
- Retrieval returning best-match passages  
- Deepseek-r1 generates full answers from the retrieved chunks

---

## Usage Example
**Query:**
```csharp
What is a service dog?
```

**Retriever Output (chunk snippet):**
```css
"... A therapy dog or an emotional support dog, even if classified as such by a physician, is not considered a guide or service dog within the meaning of this by-law ..."
```

**Answer (Deepseek-r1):**
```csharp
A service dog is a trained animal that assists individuals with disabilities in performing specific tasks...
```

---

## Workflow Testing
Both Workflow1 and Workflow2 now include Mockito-based offline tests:
```java
Workflow2.run("What is GraphRAG?");
```
Mocks Supabase retrieval and ensures the workflow executes without a live Supabase or Ollama instance.
Fetches OLLAMA_URL and OLLAMA_MODEL from config.properties automatically.

---

## Roadmap / TODO
- [x] Use Qwen3 for retrieval  
- [x] Hook up **Supabase Vector Store** for persistent, cloud-based embeddings  
- [x] Hook up an **LLM for query processing** (use retrieved chunks as context ‚Üí answer user queries)  
- [ ] Improve **chunking & formatting** for better readability
- [ ] Fix **graph generation** for better useablity and readability  
- [ ] Add support for multiple embedding models  

---

## Version History
- **v1.65** ‚Äì Improved graph generation, implemented wikidata relationships.
- **v1.6** ‚Äì Added **Deepseek-r1** via Ollama for processing the retrieved results and implemented Mockito-based tests for Workflow1 and Workflow2 to enable fully mocked, offline testing.
- **v1.5** ‚Äì Switched to **Supabase Vector Store** for storing and retrieving embeddings.
- **v1.4** - Finalized using **Qwen3 embeddings** for retrieval and similarity score as well as the embedding insertion
- **v1.3** ‚Äì Switched to **Qwen3 embeddings** via Ollama.
- **v1.0** ‚Äì Added local saving of the embedings.
- **v0.9** ‚Äì Added local saving of the graph
- **v0.8** ‚Äì Initial graphRAG pipeline with TinkerPop / TinkerGraph using tf-idf embedings.  

---

## License
MIT License ‚Äì feel free to use, modify, and contribute.
